<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="reviewMapper">
	<!-- 리뷰 총 개수 -->
<!-- 	<select id="listCount" resultType="_int"> -->
<!-- 		SELECT COUNT(*) -->
<!-- 		FROM REVIEW -->
<!-- 		WHERE STATUS = 'Y' -->
<!-- 	</select> -->

	<!-- 리뷰 목록 조회 -->
	<select id="reviewList" resultType="Review">
		SELECT R.R_NO
			   ,R.MEM_ID
			   ,R.POINT
		       ,R.P_NO
			   ,R.CONTENT
			   ,R.CREATE_DATE
   			   ,A.ORIGIN_NAME
   			   ,A.CHANGE_NAME
   			   ,A.FILE_NO
   			   ,A.FILE_PATH
		FROM REVIEW R
		JOIN MEMBER M ON R.MEM_ID = M.MEM_ID
		JOIN PARKINGLOT P ON R.P_NO = P.P_NO
		JOIN ATTACHMENT A ON R.R_NO = A.REF_RNO
		WHERE R.P_NO = #{parkingNo}
		ORDER BY R.CREATE_DATE DESC			
	</select>
	
	<!-- 리뷰 작성 -->
<!-- 	<insert id="reviewInsert" parameterType="Review"> -->
<!-- 		INSERT INTO REVIEW (R_NO -->
<!-- 					  , MEM_ID -->
<!-- 					  , POINT -->
<!-- 					  , P_NO -->
<!-- 					  , CONTENT -->
<!-- 		) -->
<!-- 		VALUES(SEQ_RNO.NEXTVAL -->
<!-- 			  , #{memId} -->
<!-- 			  , #{point} -->
<!-- 			  , #{pNo} -->
<!-- 			  , #{content} -->
<!-- 		) -->
		
<!-- 	</insert> -->

	<!-- 사진 리뷰 작성 -->
	<insert id="photoInsert" parameterType="Review">
<!-- 	rNo(리뷰번호), memId(작성자), point(별점), content(내용), pNo(주차장), createDate(작성일), file(첨부파일?) -->
		<selectKey keyProperty="rNo" resultType="int"
			order="BEFORE">
			SELECT SEQ_RNO.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO REVIEW (R_NO
						  , MEM_ID
						  , POINT
						  , P_NO
						  , CONTENT
		)
		VALUES(#{rNo}
			  , #{memId}
			  , #{point}
			  , #{pNo}
			  , #{content}
		)
	</insert>
	
	
	<!-- 첨부파일 추가 -->
	<insert id="insertAttachment">
	    INSERT ALL
	    <foreach collection="list" item="at" index="i">
	        INTO ATTACHMENT (
	            FILE_NO
	           ,REF_RNO
	           ,ORIGIN_NAME
	           ,CHANGE_NAME
	           ,FILE_PATH
	        ) VALUES (
	            FILE_NO()
	           ,SEQ_RNO.CURRVAL
	           ,#{at.originName}
	           ,#{at.changeName}
	           ,#{at.filePath}
	        )
	    </foreach>
	    SELECT * FROM DUAL
	</insert>
	
	<!-- 첨부파일 목록 -->
	<select id="attachmentList" resultType="Attachment">
		SELECT FILE_NO
			  ,ORIGIN_NAME
			  ,FILE_PATH||CHANGE_NAME "CHANGE_NAME"
		FROM ATTACHMENT
		WHERE REF_RNO = #{rNo}
		ORDER BY FILE_NO
	</select>
</mapper>