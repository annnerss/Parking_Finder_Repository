<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="reviewMapper">



	<resultMap id="reviewResultSet" type="Review">
	    <id column="R_NO" property="rNo"/>
	    <result column="MEM_ID" property="memId"/>
	    <result column="POINT" property="point"/>
	    <result column="P_NO" property="pNo"/>
	    <result column="CONTENT" property="content"/>
	    <result column="ORIGIN_NAME" property="originName"/>
	    <result column="CHANGE_NAME" property="changeName"/>
	    <result column="CREATE_DATE" property="createDate"/>
		<result column="STATUS" property="status"/>
			    
	    <!-- 1:N 관계인 첨부파일 처리 -->
	    <collection property="attachmentList" ofType="Attachment">
	        <id column="FILE_NO" property="fileNo"/>
	        <result column="REF_RNO" property="refRno"/>
	        <result column="ORIGIN_NAME" property="originName"/>
	        <result column="CHANGE_NAME" property="changeName"/>
	        <result column="FILE_PATH" property="filePath"/>
	        <result column="UPLOAD_DATE" property="uploadDate"/>
	        <result column="STATUS" property="status"/>
	    </collection>
	</resultMap>
	
<!-- 	<select id="reviewList" parameterType="string" resultMap="reviewResultSet"> -->
<!-- 	    SELECT R_NO,  -->
<!-- 	    		MEM_ID,  -->
<!-- 	    		POINT,  -->
<!-- 	    		P_NO,  -->
<!-- 	    		CONTENT,  -->
<!-- 	    		CREATE_DATE,  -->
<!-- 	           	A.FILE_NO,  -->
<!-- 	           	R.CHANGE_NAME -->
<!-- 	    FROM REVIEW R -->
<!-- 	    LEFT JOIN ATTACHMENT A ON (R_NO = REF_RNO) -->
<!-- 	    WHERE P_NO = #{parkingNo} -->
<!-- 	    ORDER BY CREATE_DATE DESC -->
<!-- 	</select> -->



	<!-- 리뷰 목록 조회 -->
	<select id="reviewList" parameterType="string" resultType="Review">
		SELECT R_NO
			    ,MEM_ID
				,POINT
				,P_NO
				,CONTENT
				,CREATE_DATE
				,A.FILE_NO
				,R.CHANGE_NAME
		FROM REVIEW R
		LEFT JOIN ATTACHMENT A ON (R_NO = REF_RNO)
		WHERE P_NO = #{pNo}
		ORDER BY CREATE_DATE DESC	
	</select>
	
	<!-- 리뷰 작성 -->
<!-- 	<insert id="reviewInsert" parameterType="Review"> -->
<!-- 		INSERT INTO REVIEW (R_NO -->
<!-- 					  , MEM_ID -->
<!-- 					  , POINT -->
<!-- 					  , P_NO -->
<!-- 					  , CONTENT -->
<!-- 		) -->
<!-- 		VALUES(SEQ_RNO.NEXTVAL -->
<!-- 			  , #{memId} -->
<!-- 			  , #{point} -->
<!-- 			  , #{pNo} -->
<!-- 			  , #{content} -->
<!-- 		) -->
		
<!-- 	</insert> -->

	<!-- 사진 리뷰 작성 -->
	<insert id="photoInsert" parameterType="Review">
<!-- 	rNo(리뷰번호), memId(작성자), point(별점), content(내용), pNo(주차장), createDate(작성일), file(첨부파일?) -->
		<selectKey keyProperty="rNo" resultType="int"
			order="BEFORE">
			SELECT SEQ_RNO.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO REVIEW (R_NO
						  , MEM_ID
						  , POINT
						  , P_NO
						  , CONTENT
		)
		VALUES(#{rNo}
			  , #{memId}
			  , #{point}
			  , #{pNo}
			  , #{content}
		)
	</insert>
	
	
	<!-- 첨부파일 추가 -->
	<insert id="insertAttachment">
	    INSERT ALL
	    <foreach collection="list" item="at" index="i">
	        INTO ATTACHMENT (
	            FILE_NO
	           ,REF_RNO
	           ,ORIGIN_NAME
	           ,CHANGE_NAME
	           ,FILE_PATH
	        ) VALUES (
	            FILE_NO()
	           ,SEQ_RNO.CURRVAL
	           ,#{at.originName}
	           ,#{at.changeName}
	           ,#{at.filePath}
	        )
	    </foreach>
	    SELECT * FROM DUAL
	</insert>
	
	<!-- 첨부파일 목록 -->
	<select id="attachmentList" resultType="Attachment">
		SELECT FILE_NO
			  ,ORIGIN_NAME
			  ,FILE_PATH||CHANGE_NAME "CHANGE_NAME"
		FROM ATTACHMENT
		WHERE REF_RNO = #{rNo}
		ORDER BY FILE_NO
	</select>
</mapper>